# 4강

## 4-1강

- k8s의 동작 방식.
- kubelet
- control plane 의 구성 요소
    - API
    - etcd 저장소
    - scheduler
    - controller

<br>

### 4-1 정리

k8s 의 동작 방식: kubectl 로 nginx 실행시켜 줘. 했을 때 과정.

1. master plane 의 API가 해당 명령을 받고 문법이 적절한지 검사하여 적절하다면 etcd에 pod 로 저장함. 이때 pod는 실행 상태는 아님.
2. scheduler 는 계속 API를 주시(watch)하다가 실행해야 할 pod가 생기면 etcd의 정보를 바탕으로 가장 실행하기 적합한 node를 찾고 API에 “이 pod는 이 node에서 돌려라“ 함.
3. 선택된 노드 정보가 API에게 들어오면, API는 해당 노드의 kubelet 에게 컨테이너 생성 명령을 내림.
4. kubelet은 Docker Hub 같은 이미지 레지스트리에서 nginx 이미지를 pull 하라고 컨테이너 런타임에 요청함. 도커(컨테이너 런타임, containerd를 쓸 수도 있지만 많이 쓰는 게 도커 이므로 도커라고 씀.)에게 명령을 내림.
5. 명령 받은 도커는 pod를 띄우고 띄운 pod에 nginx 컨테이너를 실행시킴.
6. 실행된 컨테이너는 control plane의 controller에서 계속 감시 함. 해당 노드가 다운되거나 컨테이너가 다운되면 controller에 명시된 최소 실행 보장 개수를 만족할 수 있도록 새 파드를 띄우거나 새 노드를 띄워서 다시 해당 컨테이너를 실행 시킴.

<br>

기타: 각 워커 노드들의 모든 정보는 `kubelet` 의 `cAdvisor`  가 감시하면서 `kube-proxy` 를 통해 API에게 정보를 보내고 `API` 는 이를 `etcd` 에 저장함.

<br>

## 4-2강

쿠버네티스는 api를 배우는 거다.

“마스터 노드야 api 실행해줘~”

<br>

### namespace

- 설명: api 서버를 여러개 처럼 보이게 하는 것.
- 생성 법
    - CLI
    - yam
- default namespace
    - `kube-`  로 시작하는 애들은 k8s가 관리를 위해 만들어둔 것.
    - 변경법:  context 변경

### ns 변경법.

1. `kubectl config current-context` 로 현재 context 확인.
2. kubeconfig 파일을 변경해야 함. 두 가지 방법 존재.
    - `~/.kube/config`  파일에 context 추가
    - 새로운 config.yaml 파일을 만들고 `export KUBECONFIG=<config 파일 경로>`  설저앟면 해당 세션에서는 해당 config 사용 가능.
        - 자세한건 아래 참고

3. 사용하는 context를 변경해야 함. 이것도 두 가지 방법 존재.
    - config 파일 수정: kubeconfig 파일의 `current-context` 를 수정하면 됨.
    - `kubectl config use-context <context명>` 

<br>

### 기본 ns 변경시 kubeconfig에 대한 사실.

**yaml 예시**

```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://192.168.0.126:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: gumo
  name: gumo-context
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: gumo
  user:
    token: REDACTED
- name: kubernetes-admin
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
```

<br>

- 기본 경로는 `~/.kube/config`  이다.
- `export KUBECONFIG=<config 파일 경로>` 를 통해서 해당 세션에서 사용할 클러스터 접속용 인증정보 파일을 지정할 수 있다.
    - `<config 파일 경로: 파일 경로>` 를 통해서 여러 config 파일을 합칠 수 있다. **단, 중복되는 요소가 있을 경우 먼저 선언된 것을 우선으로 한다.**
    - `export` 명령어는 현재 세션에서만 유효한 환경변수 설정 명령어 이기 때문에, 다른 사람이 세션에 접근하면 기본 경로를 보게 된다.

<br>

### 사용한 명령어

- `kubectl get namespaces` 
- `kubectl get pods -n` 
- `kubectl create -f a.yaml -n orange` 
- `kubectl config view` 
- `kubectl config set-context blue@kubernetes --cluster=kubernetes --user=kubernetes-admin -n=blue`  
- `kubectl config current-context` 
- `kubectl config use-context blue@kubernetes` 
- `kubectl delete namespaces blue` 

<br>

## 4-3강

### yaml 템플릿

scalar 문법: key: value

배열 문법: 

key:

  - chidKey1:

  grandChildKey: value

  - childKey2:

  grandChildKey: value

<br>

### API Version

CNCF 재단에서 관리함. 

alpha → beta → stable 버전으로 관리됨.

<br>

k8s object 마다 전부 버전이 다름.

<br>

아래 명령어로 확인 가능.

`kubectl explain pod` 